# PacketPony Example Configuration

server:
  name: "packetpony-01"

# Logging configuration
logging:
  # Syslog configuration
  syslog:
    enabled: false           # Disabled by default - use stdout for journald
    network: "udp"          # udp, tcp, or unix
    address: "localhost:514"
    tag: "packetpony"
    priority: "info"         # debug, info, warning, error

  # JSON file logging (optional)
  jsonlog:
    enabled: false
    path: "/var/log/packetpony/events.json"

  # Stdout logging - recommended for systemd/journald
  # When running under systemd, logs are automatically captured by journald
  stdout:
    enabled: true
    use_json: false          # false = human-readable text, true = JSON format

# Metrics configuration
metrics:
  prometheus:
    enabled: true
    listen_address: ":9090"
    path: "/metrics"

# Listener configurations
listeners:
  # Example TCP proxy - HTTP traffic
  - name: "http-proxy"
    protocol: "tcp"
    listen_address: "0.0.0.0:8080"
    target_address: "192.168.1.100:80"

    # Access control - allow specific IPs and CIDR ranges
    allowlist:
      - "10.0.0.0/8"
      - "192.168.0.0/16"
      - "172.16.0.0/12"

    # Rate limiting configuration
    rate_limits:
      max_connections_per_ip: 100           # Max concurrent connections per IP
      connections_window: "1m"              # Time window for connection counting
      max_connection_attempts_per_ip: 500   # Max connection attempts (including rejected)
      attempts_window: "1m"                 # Time window for attempt counting
      max_bandwidth_per_ip: "10MB"          # Max bandwidth per IP per window (bidirectional)
      bandwidth_window: "1m"                # Time window for bandwidth measurement
      max_total_connections: 1000           # Max total concurrent connections
      action: "drop"                        # Action on rate limit: drop, throttle, log_only
      # throttle_minimum: "1MB"             # Required if action is "throttle"

    # TCP-specific settings
    tcp:
      read_timeout: "30s"
      write_timeout: "30s"
      idle_timeout: "5m"

  # Example TCP proxy - HTTPS traffic
  - name: "https-proxy"
    protocol: "tcp"
    listen_address: "0.0.0.0:8443"
    target_address: "192.168.1.100:443"

    allowlist:
      - "0.0.0.0/0"    # Allow all IPv4

    rate_limits:
      max_connections_per_ip: 50
      connections_window: "30s"
      max_connection_attempts_per_ip: 200
      attempts_window: "30s"
      max_bandwidth_per_ip: "50MB"
      bandwidth_window: "1m"
      max_total_connections: 500
      action: "throttle"                    # Throttle instead of drop
      throttle_minimum: "5MB"               # Minimum bandwidth when throttling

    tcp:
      read_timeout: "60s"
      write_timeout: "60s"
      idle_timeout: "10m"

  # Example UDP proxy - DNS traffic
  - name: "dns-proxy"
    protocol: "udp"
    listen_address: "0.0.0.0:5353"
    target_address: "8.8.8.8:53"

    allowlist:
      - "0.0.0.0/0"    # Allow all IPv4
      - "::/0"         # Allow all IPv6

    rate_limits:
      max_connections_per_ip: 100       # Max concurrent sessions per IP
      connections_window: "10s"
      max_connection_attempts_per_ip: 500
      attempts_window: "10s"
      max_bandwidth_per_ip: "1MB"
      bandwidth_window: "10s"
      max_total_connections: 1000
      action: "log_only"                # Log violations but don't enforce

    # UDP-specific settings
    udp:
      session_timeout: "30s"   # Idle timeout for UDP sessions
      buffer_size: 4096        # Buffer size for UDP packets

  # Example UDP proxy - Custom service
  - name: "game-server-proxy"
    protocol: "udp"
    listen_address: "[::]:9000"   # IPv6 any address
    target_address: "192.168.1.50:9000"

    # Restrict to specific IPs
    allowlist:
      - "203.0.113.0/24"
      - "198.51.100.42"

    rate_limits:
      max_connections_per_ip: 10
      connections_window: "5m"
      max_connection_attempts_per_ip: 50
      attempts_window: "5m"
      max_bandwidth_per_ip: "5MB"
      bandwidth_window: "1m"
      max_total_connections: 100
      action: "drop"

    udp:
      session_timeout: "2m"
      buffer_size: 8192

  # Example TCP proxy with minimal rate limiting
  - name: "ssh-proxy"
    protocol: "tcp"
    listen_address: "0.0.0.0:2222"
    target_address: "192.168.1.10:22"

    allowlist:
      - "192.168.1.0/24"   # Only local network

    rate_limits:
      max_connections_per_ip: 3         # Limit SSH connections
      connections_window: "5m"
      max_connection_attempts_per_ip: 10  # Allow some retries
      attempts_window: "5m"
      max_bandwidth_per_ip: "100MB"
      bandwidth_window: "5m"
      max_total_connections: 20
      action: "drop"

    tcp:
      read_timeout: "0s"    # 0 means no timeout
      write_timeout: "0s"
      idle_timeout: "30m"
